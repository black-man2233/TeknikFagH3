name: Build and Deploy via MSDeploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: windows-latest

    steps:
      # Step 1: Checkout code
      - name: üßæ Checkout Code
        uses: actions/checkout@v4
      
      # Step 2: Setup .NET 9
      - name: üß∞ Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      
      # Step 3: Restore project dependencies
      - name: üî® Restore
        run: dotnet restore
      
      # Step 4: Build the project
      - name: üõ†Ô∏è Build
        run: dotnet build --configuration Release --no-restore
      
      # Step 5: Publish the project
      - name: üì¶ Publish
        run: dotnet publish -c Release -o published
      
      # Step 6: Deploy using MSDeploy
      - name: üöÄ Deploy via MSDeploy
        run: |
          # Construct msdeploy command
          $msdeployCommand = '"C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" -verb:sync -source:contentPath="published" -dest:contentPath="${{ secrets.MSDEPLOY_SITE_NAME }}", computerName="https://${{ secrets.MSDEPLOY_SERVER }}/msdeploy.axd?site=${{ secrets.MSDEPLOY_SITE_NAME }}", userName="${{ secrets.MSDEPLOY_USERNAME }}", password="${{ secrets.MSDEPLOY_PASSWORD }}", authType="Basic" -allowUntrusted'
          
          # Run the msdeploy command using Invoke-Expression
          Write-Host "Running msdeploy with the following command:"
          Write-Host $msdeployCommand
          Invoke-Expression $msdeployCommand
        shell: pwsh
        env:
          DOTNET_ROOT: C:\Program Files\dotnet
